<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sketchfab VR Viewer (Floor Fix)</title>
<script src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>
<style>
body { margin: 0; font-family: sans-serif; background: #111; color: #eee; }
#controls { padding: 8px; background: #222; }
#controls input { width: 60%; padding: 4px; }
iframe { width: 100vw; height: 90vh; border: none; }
.delay-btn {
  background: #444;
  color: #fff;
  border: 1px solid #666;
  padding: 6px 12px;
  margin: 4px;
  cursor: pointer;
}
.delay-btn.pressed {
  background: #28a745; /* green */
  border-color: #1e7e34;
}
</style>
</head>
<body>
<div id="controls">
      Paste Sketchfab link:
      <input id="url" value="https://sketchfab.com/3d-models/bsa-ww2-folding-paratrooper-bicycle-4e57c57230fe467c8b618bcd28f14af8">
      <button onclick="loadModel()">Load Model</button>
      Lower the camera to x height above the floor
      <button class="delay-btn" onclick="setAboveFloorHeight(0, this)">0.0</button>
      <button class="delay-btn" onclick="setAboveFloorHeight(0.1, this)">0.1</button>
      <button class="delay-btn" onclick="setAboveFloorHeight(0.2, this)">0.2</button>
      <button class="delay-btn" onclick="setAboveFloorHeight(0.3, this)">0.3</button>
      <button class="delay-btn" onclick="setAboveFloorHeight(0.5, this)">0.5</button>
      <button class="delay-btn" onclick="setAboveFloorHeight(0.7, this)">0.7</button>
      <button class="delay-btn" onclick="setAboveFloorHeight(1, this)">1.0</button>
      <button class="delay-btn" onclick="setAboveFloorHeight(1.5, this)">1.5</button>
      <button class="delay-btn" onclick="setAboveFloorHeight(2, this)">2.0</button>
      <button class="delay-btn" onclick="setAboveFloorHeight(3, this)">3.0</button>
      <button class="delay-btn" onclick="setAboveFloorHeight(5, this)">5.0</button>
      <button class="delay-btn" onclick="setAboveFloorHeight(10, this)">10.0</button>


</div>
<div id="sketchfab-embed-wrapper"> 
     <!-- <iframe id="api-frame" width="640" height="480" frameborder="0" allow="autoplay; fullscreen; xr-spatial-tracking" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" execution-while-out-of-viewport execution-while-not-rendered web-share></iframe> -->

     <!-- <iframe title="BSA WW2 folding paratrooper bicycle" frameborder="0" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" allow="autoplay; fullscreen; xr-spatial-tracking" xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share src="https://sketchfab.com/models/4e57c57230fe467c8b618bcd28f14af8/embed">
      </iframe> -->
    
</div>
<div>
        <p style="font-size: 13px; font-weight: normal; margin: 5px; color: #4A4A4A;"> <a href="https://sketchfab.com/3d-models/bsa-ww2-folding-paratrooper-bicycle-4e57c57230fe467c8b618bcd28f14af8?utm_medium=embed&utm_campaign=share-popup&utm_content=4e57c57230fe467c8b618bcd28f14af8" target="_blank" rel="nofollow" style="font-weight: bold; color: #1CAAD9;"> BSA WW2 folding paratrooper bicycle </a> by <a href="https://sketchfab.com/jameshughdalton?utm_medium=embed&utm_campaign=share-popup&utm_content=4e57c57230fe467c8b618bcd28f14af8" target="_blank" rel="nofollow" style="font-weight: bold; color: #1CAAD9;"> jameshughdalton </a> on <a href="https://sketchfab.com?utm_medium=embed&utm_campaign=share-popup&utm_content=4e57c57230fe467c8b618bcd28f14af8" target="_blank" rel="nofollow" style="font-weight: bold; color: #1CAAD9;">Sketchfab</a>
       </p>
</div>

<script> 
      let api
      let nodesGlobal
      const margin = Math.cos(45 * Math.PI / 180); // ~0.966
      const UP = [0, 0, 1];
      let triggerCount = 0;
      const triggerDuration = 2;
      let aboveFloorHeight = 0;
      let prevBtn;
      //let cameraTimer = null;
      //let savedPos = null;
      /*function lowerCameraToFloorDelayed(delay, btn){
              if (cameraTimer){
                  return
              }
               btn.classList.add("pressed");
              api.getCameraLookAt((err, camera) => 
                {
                  cameraTimer = setTimeout(() => lowerCameraToFloor(btn, err, camera), delay * 1000)   
                })
            
      } */      
        function setAboveFloorHeight(height, btn){
          prevBtn.classList.remove("pressed");
          
          aboveFloorHeight = height
          btn.classList.add("pressed");
          prevBtn = btn
        }

      function normalize(v) {
        const len = Math.hypot(v[0], v[1], v[2]);
        return [v[0]/len, v[1]/len, v[2]/len];
      }
      function dotProduct(vec1, vec2){
          return vec1[0] * vec2[0] + vec1[1] * vec2[1] + vec1[2] * vec2[2]
      }
      function startCheckingCameraLoweringThreshold()
        {    
              setInterval(() => api.getCameraLookAt(checkTarget), 1000)   
        }
  
      function checkTarget(err, camera){
          const ray = [
            camera.target[0] - camera.position[0],
            camera.target[1] - camera.position[1],
            camera.target[2] - camera.position[2]
          ];
          let normRay = normalize(ray) 
          let dot = dotProduct(UP, normRay)
          if (dot >= margin){
                triggerCount++
                if (triggerCount <= triggerDuration)
                {
                    return
                }
                lowerCameraToFloor(camera) 
          }
          triggerCount = 0
      }

      function lowerCameraToFloor(camera){

              let previousPos = camera.position
               api.setCameraLookAt([previousPos[0], previousPos[1], aboveFloorHeight], [0, 0, 0], 0, function(err) {
                      if (!err) {
                          window.console.log('Camera moved');
                      }
                  });
                //btn.classList.remove("pressed");

           // cameraTimer = null
      }
      
      function extractUid(url) {
            // Match the 32-char model UID at the end of a Sketchfab URL
            const match = url.match(/([a-zA-Z0-9]{32})(?:\?.*)?$/);
            return match ? match[1] : null;
      }
      function startApiFunc(apiInstance){
            api = apiInstance
            //const func = addEventListenerFunc(api) -->
            api.start()
            startCheckingCameraLoweringThreshold()
      }
     /* function addEventListenerFunc(api){
            
            const func = getNodeMapFunc(api)
            return function (){
            
                api.addEventListener("viewerready", function(){
                    func()  
                })
            }
      }
      function getNodeMapFunc(api){
           const func = translate(api)
           return function (){
               api.getNodeMap(func)
           }
      }

      function translate(api){
          return function(err, nodes)
          {
            
                startCameraAnimation()
              nodesGlobal = nodes
              if (!err) {      // root node id
                  api.translate(0, [0, 0, 2]); // lift whole scene by +1.6 meters (Y up)
              }
            
          }
      } */

      function init(){
           let collection = document.getElementsByClassName("delay-btn");
            prevBtn = collection[0]
            setAboveFloorHeight(0, prevBtn)
      }
            
      function loadModel()
      {
     
      const url = document.getElementById("url").value.trim();
      const uid = extractUid(url);
      if (!uid) {
            alert("Invalid Sketchfab URL");
            return;
       }
      const iframe = document.createElement("iframe");
      iframe.src = "https://sketchfab.com/models/" + uid + "/embed?autostart=1";
      iframe.setAttribute("allow", "autoplay; fullscreen; xr-spatial-tracking");
      iframe.setAttribute("allowfullscreen", "");
      iframe.setAttribute("mozallowfullscreen", "true");
      iframe.setAttribute("webkitallowfullscreen", "true");
      
      // Boolean or feature-policy attributes
      iframe.setAttribute("execution-while-out-of-viewport", "");
      iframe.setAttribute("execution-while-not-rendered", "");
      iframe.setAttribute("web-share", "");
      iframe.width = "100%";
      iframe.height = "100%";
      iframe.frameBorder = "0";
      const container = document.getElementById("sketchfab-embed-wrapper");
      container.innerHTML = "";
      container.appendChild(iframe);
        const client = new Sketchfab(iframe);
        client.init(uid, 
          {success: startApiFunc, 
            error: function() { console.error("API init failed")}
          }
         )
      }
      window.onload = init
</script>

</body>
</html>
